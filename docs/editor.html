<!DOCTYPE html>
<html>

<head>
  <title>Fire'n Ice - Level Editor</title>
  <link rel="icon" type="image/png" sizes="32x32" href="images/favicon-32x32.png" />
  <link rel="icon" type="image/png" sizes="16x16" href="images/favicon-16x16.png" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="./scripts/firenice.js"></script>
  <script src="./scripts/editor.js"></script>
  <style>
    * {
      box-sizing: border-box;
    }

    body,
    html {
      height: 100%;
      margin: 0;
      padding: 0;
    }

    body {
      background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
      font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
      color: #e4e4e4;
      min-height: 100vh;
    }

    /* Header */
    .editor-header {
      background: rgba(0, 0, 0, 0.4);
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      padding: 12px 20px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      backdrop-filter: blur(10px);
    }

    .editor-title {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .editor-title h1 {
      margin: 0;
      font-size: 20px;
      font-weight: 600;
      background: linear-gradient(90deg, #00d4ff, #ff6b9d);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .editor-title .badge {
      background: rgba(255, 107, 157, 0.2);
      color: #ff6b9d;
      font-size: 10px;
      padding: 3px 8px;
      border-radius: 10px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .header-actions {
      display: flex;
      gap: 8px;
    }

    /* Main Layout */
    .editor-container {
      display: flex;
      height: calc(100vh - 57px);
    }

    /* Sidebar */
    .editor-sidebar {
      width: 220px;
      background: rgba(0, 0, 0, 0.3);
      border-right: 1px solid rgba(255, 255, 255, 0.1);
      display: flex;
      flex-direction: column;
      overflow-y: auto;
    }

    .sidebar-section {
      padding: 16px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.05);
    }

    .sidebar-section:last-child {
      border-bottom: none;
    }

    .section-title {
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 1px;
      color: #888;
      margin-bottom: 12px;
    }

    /* Tool Grid */
    .tool-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 8px;
    }

    .tool-btn {
      position: relative;
      background: rgba(255, 255, 255, 0.05);
      border: 2px solid transparent;
      border-radius: 8px;
      padding: 8px;
      cursor: pointer;
      transition: all 0.15s ease;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 6px;
    }

    .tool-btn:hover {
      background: rgba(255, 255, 255, 0.1);
      border-color: rgba(255, 255, 255, 0.2);
    }

    .tool-btn.active {
      background: rgba(0, 212, 255, 0.15);
      border-color: #00d4ff;
      box-shadow: 0 0 12px rgba(0, 212, 255, 0.3);
    }

    .tool-btn .icon {
      width: 32px;
      height: 32px;
      image-rendering: pixelated;
      image-rendering: crisp-edges;
    }

    .tool-btn .label {
      font-size: 10px;
      color: #aaa;
      text-align: center;
    }

    .tool-btn.active .label {
      color: #00d4ff;
    }

    .tool-btn .shortcut {
      position: absolute;
      top: 4px;
      right: 4px;
      font-size: 9px;
      color: #666;
      background: rgba(0, 0, 0, 0.3);
      padding: 1px 4px;
      border-radius: 3px;
    }

    /* Sprite icon containers */
    .sprite-icon {
      width: 32px;
      height: 32px;
      overflow: hidden;
      position: relative;
    }

    .sprite-icon img {
      position: absolute;
      image-rendering: pixelated;
      image-rendering: crisp-edges;
    }

    /* Custom icon styles for each tool */
    .icon-erase {
      background: linear-gradient(45deg, #333 25%, #444 25%, #444 50%, #333 50%, #333 75%, #444 75%);
      background-size: 8px 8px;
      border-radius: 4px;
    }

    .icon-wall {
      background: linear-gradient(135deg, #5a4a3a, #3a2a1a);
      border-radius: 4px;
      border: 2px solid #2a1a0a;
    }

    /* Theme Selector */
    .theme-grid {
      display: grid;
      grid-template-columns: repeat(5, 1fr);
      gap: 6px;
    }

    .theme-btn {
      width: 100%;
      aspect-ratio: 1;
      border: 2px solid transparent;
      border-radius: 6px;
      cursor: pointer;
      overflow: hidden;
      transition: all 0.15s ease;
      position: relative;
    }

    .theme-btn:hover {
      border-color: rgba(255, 255, 255, 0.3);
      transform: scale(1.05);
    }

    .theme-btn.active {
      border-color: #00d4ff;
      box-shadow: 0 0 8px rgba(0, 212, 255, 0.4);
    }

    .theme-btn .preview {
      width: 100%;
      height: 100%;
      image-rendering: pixelated;
      object-fit: cover;
    }

    .theme-btn .number {
      position: absolute;
      bottom: 2px;
      right: 2px;
      font-size: 9px;
      background: rgba(0, 0, 0, 0.7);
      color: #fff;
      padding: 1px 4px;
      border-radius: 3px;
    }

    /* Level Selector */
    .level-select {
      width: 100%;
      background: rgba(0, 0, 0, 0.3);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 6px;
      color: #e4e4e4;
      padding: 10px 12px;
      font-size: 13px;
      cursor: pointer;
      transition: all 0.15s ease;
    }

    .level-select:hover {
      border-color: rgba(255, 255, 255, 0.2);
    }

    .level-select:focus {
      outline: none;
      border-color: #00d4ff;
    }

    /* Canvas Area */
    .editor-main {
      flex: 1;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    .canvas-toolbar {
      background: rgba(0, 0, 0, 0.2);
      padding: 10px 16px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      border-bottom: 1px solid rgba(255, 255, 255, 0.05);
    }

    .toolbar-group {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .toolbar-btn {
      background: rgba(255, 255, 255, 0.08);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 6px;
      color: #ccc;
      padding: 8px 14px;
      font-size: 13px;
      cursor: pointer;
      transition: all 0.15s ease;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .toolbar-btn:hover {
      background: rgba(255, 255, 255, 0.12);
      color: #fff;
    }

    .toolbar-btn.primary {
      background: rgba(0, 212, 255, 0.2);
      border-color: rgba(0, 212, 255, 0.3);
      color: #00d4ff;
    }

    .toolbar-btn.primary:hover {
      background: rgba(0, 212, 255, 0.3);
    }

    .toolbar-btn.danger {
      background: rgba(255, 107, 107, 0.15);
      border-color: rgba(255, 107, 107, 0.2);
      color: #ff6b6b;
    }

    .toolbar-btn.danger:hover {
      background: rgba(255, 107, 107, 0.25);
    }

    .toolbar-divider {
      width: 1px;
      height: 24px;
      background: rgba(255, 255, 255, 0.1);
      margin: 0 4px;
    }

    .canvas-wrapper {
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
      overflow: auto;
      background:
        linear-gradient(90deg, rgba(255, 255, 255, 0.03) 1px, transparent 1px),
        linear-gradient(rgba(255, 255, 255, 0.03) 1px, transparent 1px);
      background-size: 32px 32px;
    }

    .canvas-container {
      position: relative;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
      border-radius: 4px;
      overflow: hidden;
    }

    #canvas {
      display: block;
      cursor: crosshair;
    }

    #loader {
      position: absolute;
      inset: 0;
      background: linear-gradient(180deg, #0a0a20 0%, #1a1a40 50%, #0a0a20 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
    }

    .loader-content {
      text-align: center;
    }

    .loader-title {
      font-size: 24px;
      font-weight: bold;
      margin-bottom: 16px;
      background: linear-gradient(90deg, #00d4ff, #ff6b9d);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }

    .loader-hint {
      color: #888;
      font-size: 14px;
      animation: pulse 2s ease-in-out infinite;
    }

    @keyframes pulse {

      0%,
      100% {
        opacity: 0.5;
      }

      50% {
        opacity: 1;
      }
    }

    /* Output Panel */
    .output-panel {
      background: rgba(0, 0, 0, 0.4);
      border-top: 1px solid rgba(255, 255, 255, 0.1);
      padding: 12px 16px;
    }

    .output-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 8px;
    }

    .output-title {
      font-size: 12px;
      font-weight: 600;
      color: #888;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .output-actions {
      display: flex;
      gap: 6px;
    }

    .output-btn {
      background: rgba(255, 255, 255, 0.08);
      border: none;
      border-radius: 4px;
      color: #aaa;
      padding: 4px 10px;
      font-size: 11px;
      cursor: pointer;
      transition: all 0.15s ease;
    }

    .output-btn:hover {
      background: rgba(255, 255, 255, 0.15);
      color: #fff;
    }

    .output-btn.copied {
      background: rgba(76, 175, 80, 0.3);
      color: #4caf50;
    }

    #txt-level {
      width: 100%;
      height: 80px;
      background: rgba(0, 0, 0, 0.4);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 6px;
      color: #7fdbca;
      font-family: 'Consolas', 'Monaco', monospace;
      font-size: 11px;
      padding: 10px;
      resize: vertical;
      line-height: 1.5;
    }

    #txt-level:focus {
      outline: none;
      border-color: rgba(0, 212, 255, 0.5);
    }

    /* Status Bar */
    .status-bar {
      background: rgba(0, 0, 0, 0.5);
      border-top: 1px solid rgba(255, 255, 255, 0.1);
      padding: 6px 16px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      font-size: 11px;
      color: #666;
    }

    .status-item {
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .status-dot {
      width: 6px;
      height: 6px;
      border-radius: 50%;
      background: #4caf50;
    }

    /* Keyboard shortcuts help */
    .shortcuts-list {
      display: flex;
      flex-direction: column;
      gap: 6px;
      margin-top: 8px;
    }

    .shortcut-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 11px;
    }

    .shortcut-item .key {
      background: rgba(255, 255, 255, 0.1);
      padding: 2px 6px;
      border-radius: 3px;
      font-family: monospace;
      color: #aaa;
    }

    .shortcut-item .desc {
      color: #666;
    }

    /* Toast notification */
    .toast {
      position: fixed;
      bottom: 80px;
      left: 50%;
      transform: translateX(-50%) translateY(100px);
      background: rgba(0, 0, 0, 0.9);
      color: #fff;
      padding: 12px 20px;
      border-radius: 8px;
      font-size: 13px;
      opacity: 0;
      transition: all 0.3s ease;
      pointer-events: none;
      z-index: 1000;
    }

    .toast.show {
      transform: translateX(-50%) translateY(0);
      opacity: 1;
    }

    .toast.success {
      border-left: 3px solid #4caf50;
    }

    .toast.info {
      border-left: 3px solid #00d4ff;
    }

    /* Hidden audio elements */
    .hidden {
      display: none;
    }

    /* Responsive */
    @media (max-width: 900px) {
      .editor-container {
        flex-direction: column;
      }

      .editor-sidebar {
        width: 100%;
        flex-direction: row;
        flex-wrap: wrap;
        border-right: none;
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      }

      .sidebar-section {
        flex: 1;
        min-width: 200px;
        border-bottom: none;
        border-right: 1px solid rgba(255, 255, 255, 0.05);
      }

      .tool-grid {
        grid-template-columns: repeat(4, 1fr);
      }
    }
  </style>
</head>

<body>
  <!-- Header -->
  <header class="editor-header">
    <div class="editor-title">
      <h1>Fire 'n Ice Level Editor</h1>
      <span class="badge">Beta</span>
    </div>
    <div class="header-actions">
      <a href="index.html" class="toolbar-btn">Back to Game</a>
    </div>
  </header>

  <!-- Main Container -->
  <div class="editor-container">
    <!-- Sidebar -->
    <aside class="editor-sidebar">
      <!-- Tools Section -->
      <div class="sidebar-section">
        <div class="section-title">Tools</div>
        <div class="tool-grid" id="tool-grid">
          <button class="tool-btn" data-tool="0" title="Erase / Empty space (E)">
            <div class="icon icon-erase"></div>
            <span class="label">Erase</span>
            <span class="shortcut">E</span>
          </button>
          <button class="tool-btn active" data-tool="1" title="Wall block (W)">
            <div class="icon icon-wall"></div>
            <span class="label">Wall</span>
            <span class="shortcut">W</span>
          </button>
          <button class="tool-btn" data-tool="7" title="Player start position (P)">
            <div class="sprite-icon icon">
              <img src="images/dona.png" style="top: 0; left: 0; width: auto; height: 32px;">
            </div>
            <span class="label">Player</span>
            <span class="shortcut">P</span>
          </button>
          <button class="tool-btn" data-tool="6" title="Fire enemy (F)">
            <div class="sprite-icon icon">
              <img src="images/fire.png" style="top: 0; left: 0; width: auto; height: 32px;">
            </div>
            <span class="label">Fire</span>
            <span class="shortcut">F</span>
          </button>
          <button class="tool-btn" data-tool="3" title="Ice block (I)">
            <div class="sprite-icon icon">
              <img src="images/ice.png" style="top: 0; left: 0; width: auto; height: 32px;">
            </div>
            <span class="label">Ice</span>
            <span class="shortcut">I</span>
          </button>
          <button class="tool-btn" data-tool="4" title="Metal block (M)">
            <div class="sprite-icon icon">
              <img src="images/metal.png" style="top: 0; left: 0; width: auto; height: 32px;">
            </div>
            <span class="label">Metal</span>
            <span class="shortcut">M</span>
          </button>
          <button class="tool-btn" data-tool="5" title="Jar / Timer (J)">
            <div class="sprite-icon icon">
              <img src="images/jar.png" style="top: 0; left: 0; width: auto; height: 32px;">
            </div>
            <span class="label">Jar</span>
            <span class="shortcut">J</span>
          </button>
          <button class="tool-btn" data-tool="8" title="Teleporter (T)">
            <div class="sprite-icon icon">
              <img src="images/teleport.png" style="top: 0; left: 0; width: auto; height: 32px;">
            </div>
            <span class="label">Teleport</span>
            <span class="shortcut">T</span>
          </button>
        </div>
      </div>

      <!-- Theme Section -->
      <div class="sidebar-section">
        <div class="section-title">Theme</div>
        <div class="theme-grid" id="theme-grid"></div>
      </div>

      <!-- Level Section -->
      <div class="sidebar-section">
        <div class="section-title">Load Level</div>
        <select class="level-select" id="level-selector">
          <option value="-1">New Level</option>
        </select>
      </div>

      <!-- Shortcuts Section -->
      <div class="sidebar-section">
        <div class="section-title">Shortcuts</div>
        <div class="shortcuts-list">
          <div class="shortcut-item">
            <span class="key">1-8</span>
            <span class="desc">Select tool</span>
          </div>
          <div class="shortcut-item">
            <span class="key">Ctrl+S</span>
            <span class="desc">Export JSON</span>
          </div>
          <div class="shortcut-item">
            <span class="key">Ctrl+C</span>
            <span class="desc">Copy JSON</span>
          </div>
          <div class="shortcut-item">
            <span class="key">R</span>
            <span class="desc">Reload level</span>
          </div>
        </div>
      </div>
    </aside>

    <!-- Main Content -->
    <main class="editor-main">
      <!-- Toolbar -->
      <div class="canvas-toolbar">
        <div class="toolbar-group">
          <button class="toolbar-btn" id="btn-reload" title="Reload current level (R)">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M23 4v6h-6M1 20v-6h6" />
              <path d="M3.51 9a9 9 0 0114.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0020.49 15" />
            </svg>
            Reload
          </button>
          <button class="toolbar-btn danger" id="btn-clear" title="Clear all sprites">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M3 6h18M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2" />
            </svg>
            Clear
          </button>
        </div>
        <div class="toolbar-group">
          <span style="color: #666; font-size: 12px;">Grid: 21 x 15</span>
          <div class="toolbar-divider"></div>
          <span id="coords-display" style="color: #888; font-size: 12px; font-family: monospace;">X: -- Y: --</span>
        </div>
      </div>

      <!-- Canvas -->
      <div class="canvas-wrapper">
        <div class="canvas-container">
          <canvas id="canvas" height="480" width="672"></canvas>
          <div id="loader">
            <div class="loader-content">
              <div class="loader-title">Level Editor</div>
              <div class="loader-hint">Click anywhere to start</div>
            </div>
          </div>
        </div>
      </div>

      <!-- Output Panel -->
      <div class="output-panel">
        <div class="output-header">
          <span class="output-title">Level JSON Output</span>
          <div class="output-actions">
            <button class="output-btn" id="btn-save">Export</button>
            <button class="output-btn" id="btn-copy">Copy</button>
            <button class="output-btn" id="btn-format">Format</button>
          </div>
        </div>
        <textarea id="txt-level" placeholder="Click 'Export' to generate level JSON..."></textarea>
      </div>

      <!-- Status Bar -->
      <div class="status-bar">
        <div class="status-item">
          <span class="status-dot"></span>
          <span>Editor Ready</span>
        </div>
        <div class="status-item">
          <span id="sprite-count">Sprites: 0</span>
        </div>
      </div>
    </main>
  </div>

  <!-- Toast Notification -->
  <div class="toast" id="toast"></div>

  <!-- Hidden Mobile Controls (required by keyboard.js) -->
  <div class="hidden">
    <span id="btn_left"></span>
    <span id="btn_right"></span>
    <span id="btn_action"></span>
    <span id="btn_select"></span>
  </div>

  <!-- Hidden Audio -->
  <div class="hidden">
    <audio id="sfx-ice-push" src="/sounds/sfx-ice-push.mp3"></audio>
    <audio id="sfx-fire-off" src="/sounds/sfx-fire-off.mp3"></audio>
    <audio id="sfx-falling" src="/sounds/sfx-falling.mp3"></audio>
    <audio id="sfx-new-ice" src="/sounds/sfx-new-ice.mp3"></audio>
    <audio id="sfx-climb" src="/sounds/sfx-climb.mp3"></audio>
    <audio id="sfx-ice-collision" src="/sounds/sfx-ice-collision.mp3"></audio>
    <audio id="sfx-stage-enter" src="/sounds/sfx-stage-enter.mp3"></audio>
    <audio id="sfx-danger" src="/sounds/sfx-danger.mp3"></audio>
    <audio id="sfx-ice-remove" src="/sounds/sfx-ice-remove.mp3"></audio>
    <audio id="sfx-state-leave" src="/sounds/sfx-state-leave.mp3"></audio>
    <audio id="sfx-disabled" src="/sounds/sfx-disabled.mp3"></audio>
    <audio id="sfx-fall" src="/sounds/sfx-fall.mp3"></audio>
    <audio id="sfx-music-sparks" src="/music/sparks.mp3"></audio>
  </div>

  <script>
    var FIRENICE_EDITOR_MODE = false;
    var tool = 1;
    var currentTheme = 0;

    // Tool shortcuts mapping
    const toolShortcuts = {
      'e': 0, '1': 0,  // Erase
      'w': 1, '2': 1,  // Wall
      'p': 7, '3': 7,  // Player
      'f': 6, '4': 6,  // Fire
      'i': 3, '5': 3,  // Ice
      'm': 4, '6': 4,  // Metal
      'j': 5, '7': 5,  // Jar
      't': 8, '8': 8,  // Teleport
    };

    // Toast notification
    function showToast(message, type = 'info') {
      const toast = document.getElementById('toast');
      toast.textContent = message;
      toast.className = 'toast ' + type + ' show';
      setTimeout(() => {
        toast.classList.remove('show');
      }, 2500);
    }

    // Initialize theme grid
    function initThemeGrid() {
      const grid = document.getElementById('theme-grid');
      for (let i = 0; i < 10; i++) {
        const btn = document.createElement('button');
        btn.className = 'theme-btn' + (i === 0 ? ' active' : '');
        btn.dataset.theme = i;
        btn.title = 'Theme ' + i;
        btn.innerHTML = `
            <canvas class="preview" width="32" height="32"></canvas>
            <span class="number">${i}</span>
          `;
        grid.appendChild(btn);

        // Draw theme preview from tilemap
        const img = new Image();
        img.onload = function () {
          const canvas = btn.querySelector('canvas');
          const ctx = canvas.getContext('2d');
          // Draw from tilemap - each theme row is 32px apart, wall tile is at x=32
          ctx.drawImage(img, 32, i * 32, 32, 32, 0, 0, 32, 32);
        };
        img.src = 'images/tilemap.png';
      }
    }

    // Initialize level selector
    function initLevelSelector() {
      const select = document.getElementById('level-selector');
      // Will be populated after game loads
      setTimeout(() => {
        if (typeof game !== 'undefined' && game.levels) {
          for (let i = 0; i < game.levels.length; i++) {
            const option = document.createElement('option');
            option.value = i;
            option.textContent = 'Level ' + (i + 1);
            select.appendChild(option);
          }
        }
      }, 1500);
    }

    // Tool selection
    function selectTool(toolId) {
      tool = parseInt(toolId);
      document.querySelectorAll('.tool-btn').forEach(btn => {
        btn.classList.toggle('active', parseInt(btn.dataset.tool) === tool);
      });
    }

    // Theme selection
    function selectTheme(themeId) {
      currentTheme = parseInt(themeId);
      document.querySelectorAll('.theme-btn').forEach(btn => {
        btn.classList.toggle('active', parseInt(btn.dataset.theme) === currentTheme);
      });
      if (typeof game !== 'undefined' && game.engine && game.engine.map) {
        game.engine.map.theme = currentTheme;
      }
    }

    // Update sprite count
    function updateSpriteCount() {
      if (typeof game !== 'undefined' && game.engine && game.engine.sprites) {
        document.getElementById('sprite-count').textContent = 'Sprites: ' + game.engine.sprites.length;
      }
    }

    // Export level JSON
    function exportLevel() {
      if (typeof game !== 'undefined' && game.engine && game.engine.scene) {
        const data = game.engine.scene.save();
        document.getElementById('txt-level').value = JSON.stringify(data);
        showToast('Level exported successfully', 'success');
        updateSpriteCount();
      }
    }

    // Format JSON
    function formatJSON() {
      const textarea = document.getElementById('txt-level');
      try {
        const data = JSON.parse(textarea.value);
        textarea.value = JSON.stringify(data, null, 2);
        showToast('JSON formatted', 'info');
      } catch (e) {
        showToast('Invalid JSON', 'error');
      }
    }

    // Copy to clipboard
    async function copyToClipboard() {
      const textarea = document.getElementById('txt-level');
      if (!textarea.value) {
        exportLevel();
      }
      try {
        await navigator.clipboard.writeText(textarea.value);
        const btn = document.getElementById('btn-copy');
        btn.classList.add('copied');
        btn.textContent = 'Copied!';
        showToast('Copied to clipboard', 'success');
        setTimeout(() => {
          btn.classList.remove('copied');
          btn.textContent = 'Copy';
        }, 2000);
      } catch (e) {
        textarea.select();
        document.execCommand('copy');
        showToast('Copied to clipboard', 'success');
      }
    }

    // Clear level
    function clearLevel() {
      if (typeof game !== 'undefined' && game.engine) {
        // Remove all sprites except player
        game.engine.sprites = game.engine.sprites.filter(s => s.id === 7);
        showToast('Sprites cleared', 'info');
        updateSpriteCount();
      }
    }

    // Reload level
    function reloadLevel() {
      if (typeof game !== 'undefined' && game.engine && game.engine.scene) {
        game.engine.scene.load(game.engine.level);
        showToast('Level reloaded', 'info');
        updateSpriteCount();
      }
    }

    // Event Listeners
    document.addEventListener('DOMContentLoaded', () => {
      initThemeGrid();
      initLevelSelector();

      // Tool selection
      document.getElementById('tool-grid').addEventListener('click', (e) => {
        const btn = e.target.closest('.tool-btn');
        if (btn) {
          selectTool(btn.dataset.tool);
        }
      });

      // Theme selection
      document.getElementById('theme-grid').addEventListener('click', (e) => {
        const btn = e.target.closest('.theme-btn');
        if (btn) {
          selectTheme(btn.dataset.theme);
        }
      });

      // Level selector
      document.getElementById('level-selector').addEventListener('change', (e) => {
        const level = parseInt(e.target.value);
        if (level >= 0 && typeof game !== 'undefined') {
          game.engine.level = level;
          game.engine.scene.load(level);
          // Update theme selector to match loaded level
          if (game.engine.map) {
            selectTheme(game.engine.map.theme);
          }
          showToast('Loaded Level ' + (level + 1), 'info');
          updateSpriteCount();
        }
        e.target.blur();
      });

      // Toolbar buttons
      document.getElementById('btn-save').addEventListener('click', exportLevel);
      document.getElementById('btn-copy').addEventListener('click', copyToClipboard);
      document.getElementById('btn-format').addEventListener('click', formatJSON);
      document.getElementById('btn-clear').addEventListener('click', clearLevel);
      document.getElementById('btn-reload').addEventListener('click', reloadLevel);

      // Keyboard shortcuts
      document.addEventListener('keydown', (e) => {
        // Don't trigger shortcuts when typing in textarea
        if (e.target.tagName === 'TEXTAREA' || e.target.tagName === 'INPUT') {
          return;
        }

        const key = e.key.toLowerCase();

        // Tool shortcuts
        if (toolShortcuts.hasOwnProperty(key)) {
          e.preventDefault();
          selectTool(toolShortcuts[key]);
          return;
        }

        // Other shortcuts
        if (e.ctrlKey || e.metaKey) {
          if (key === 's') {
            e.preventDefault();
            exportLevel();
          } else if (key === 'c' && !window.getSelection().toString()) {
            e.preventDefault();
            copyToClipboard();
          }
        } else if (key === 'r') {
          e.preventDefault();
          reloadLevel();
        }
      });

      // Mouse coordinates display
      const canvas = document.getElementById('canvas');
      canvas.addEventListener('mousemove', (e) => {
        const rect = canvas.getBoundingClientRect();
        const scaleX = canvas.width / rect.width;
        const scaleY = canvas.height / rect.height;
        const x = Math.floor((e.clientX - rect.left) * scaleX / 32);
        const y = Math.floor((e.clientY - rect.top) * scaleY / 32);
        document.getElementById('coords-display').textContent = `X: ${x} Y: ${y}`;
      });

      canvas.addEventListener('mouseleave', () => {
        document.getElementById('coords-display').textContent = 'X: -- Y: --';
      });

      // Update sprite count periodically
      setInterval(updateSpriteCount, 1000);
    });
  </script>
</body>

</html>